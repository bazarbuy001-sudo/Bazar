generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// === КЛИЕНТЫ (B2B) ===
model Client {
  id                  String    @id @default(uuid())
  publicId            String    @unique // CL-XXXXXX
  email               String    @unique
  passwordHash        String
  name                String    // Название компании
  phone               String?
  city                String?
  inn                 String?   // ИНН (10 или 12 цифр)
  clientType          String    @default("individual") // individual | business
  companyName         String?   // Для юрлиц
  kpp                 String?   // Для юрлиц
  legalAddress        String?   // Для юрлиц
  primaryAuthMethod   String    @default("email")
  isActive            Boolean   @default(true)
  createdAt           DateTime  @default(now())
  updatedAt           DateTime  @updatedAt
  
  orders              Order[]
  carts               Cart[]
  sentMessages        Message[] @relation("SenderMessages")
  
  @@index([email])
  @@index([publicId])
  @@map("clients")
}

// === АДМИНЫ (отдельная таблица!) ===
model AdminUser {
  id            String    @id @default(uuid())
  publicId      String    @unique // ADM-XXXXXX
  email         String    @unique
  passwordHash  String
  firstName     String?
  lastName      String?
  role          String    // admin | superadmin | manager
  isActive      Boolean   @default(true)
  lastLoginAt   DateTime?
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt
  
  ordersCreated Order[]   @relation("OrderCreatedBy")
  messages      Message[] @relation("AdminMessages")
  
  @@index([email])
  @@index([role])
  @@map("admin_users")
}

// === КАТЕГОРИИ (3 уровня) ===
model Category {
  id           Int                 @id @default(autoincrement())
  name         String
  slug         String              @unique
  parentId     Int?
  parent       Category?           @relation("CategoryTree", fields: [parentId], references: [id])
  children     Category[]          @relation("CategoryTree")
  level        Int                 @default(1) // 1, 2, 3
  position     Int                 @default(0)
  productCount Int                 @default(0)
  isActive     Boolean             @default(true)
  icon         String?
  createdAt    DateTime            @default(now())
  updatedAt    DateTime            @updatedAt
  
  products     CategoryProduct[]
  
  @@index([parentId])
  @@index([slug])
  @@map("categories")
}

// === СВЯЗЬ КАТЕГОРИЯ-ТОВАР (many-to-many) ===
model CategoryProduct {
  id         Int      @id @default(autoincrement())
  categoryId Int
  productId  Int
  position   Int      @default(0)
  createdAt  DateTime @default(now())
  
  category   Category @relation(fields: [categoryId], references: [id])
  product    Product  @relation(fields: [productId], references: [id])
  
  @@unique([categoryId, productId])
  @@map("category_product")
}

// === ТОВАРЫ (ткани + фурнитура) ===
model Product {
  id             Int                 @id @default(autoincrement())
  name           String
  slug           String              @unique
  productType    String              // fabric | accessory
  price          Decimal             @db.Decimal(10, 2) // цена за метр (ткань) или штуку (фурнитура)
  unit           String              @default("METER") // METER | PIECE
  rollLength     Decimal?            @db.Decimal(10, 2) // длина рулона (только для тканей)
  minOrderQty    Decimal             @default(0.5) @db.Decimal(10, 2) // мин. заказ
  stepQty        Decimal             @default(0.1) @db.Decimal(10, 2) // шаг количества
  isNew          Boolean             @default(false)
  isOnSale       Boolean             @default(false)
  isRestRoll     Boolean             @default(false) // остаток рулона
  hasStock       Boolean             @default(true)
  stockQuantity  Decimal?            @db.Decimal(10, 2) // в метрах
  mainImage      String?
  images         Json? // массив URL
  description    String?
  createdAt      DateTime            @default(now())
  updatedAt      DateTime            @updatedAt
  
  variants       ProductVariant[]
  categories     CategoryProduct[]
  cartItems      CartItem[]
  
  @@index([slug])
  @@index([productType])
  @@map("products")
}

// === ВАРИАНТЫ ТОВАРА (цвета) ===
model ProductVariant {
  id        Int        @id @default(autoincrement())
  productId Int
  product   Product    @relation(fields: [productId], references: [id])
  colorName String     // "Бордовый"
  colorHex  String?    // "#722F37"
  sku       String?    @unique // SKU-001234
  images    Json?      // массив {url, alt}
  inStock   Boolean    @default(true)
  isActive  Boolean    @default(true)
  createdAt DateTime   @default(now())
  updatedAt DateTime   @updatedAt
  
  cartItems CartItem[]
  
  @@index([productId])
  @@map("product_variants")
}

// === КОРЗИНА ===
model Cart {
  id             String     @id @default(uuid())
  clientId       String?
  client         Client?    @relation(fields: [clientId], references: [id], onDelete: Cascade)
  sessionId      String?    // для гостей
  currency       String     @default("RUB")
  itemsCount     Int        @default(0)
  subtotal       Decimal    @default(0) @db.Decimal(10, 2)
  discountAmount Decimal    @default(0) @db.Decimal(10, 2)
  total          Decimal    @default(0) @db.Decimal(10, 2)
  promoCodeId    String?
  promoCode      PromoCode? @relation(fields: [promoCodeId], references: [id], onDelete: SetNull)
  createdAt      DateTime   @default(now())
  updatedAt      DateTime   @updatedAt
  expiresAt      DateTime?  // TTL для гостевых (30 дней)
  
  items          CartItem[]
  
  @@index([clientId])
  @@index([sessionId])
  @@index([expiresAt])
  @@map("carts")
}

// === ПОЗИЦИИ КОРЗИНЫ ===
model CartItem {
  id               String         @id @default(uuid())
  cartId           String
  cart             Cart           @relation(fields: [cartId], references: [id], onDelete: Cascade)
  productVariantId Int
  productVariant   ProductVariant @relation(fields: [productVariantId], references: [id])
  productId        Int
  product          Product        @relation(fields: [productId], references: [id])
  quantity         Decimal        @db.Decimal(10, 2) // В МЕТРАХ!
  pricePerUnit     Decimal        @db.Decimal(10, 2) // snapshot цены
  currency         String         @default("RUB")
  
  // Snapshot для offline
  productName      String
  variantName      String?
  imageUrl         String?
  
  // Флаги
  priceChanged     Boolean        @default(false)
  outOfStock       Boolean        @default(false)
  unavailable      Boolean        @default(false)
  
  createdAt        DateTime       @default(now())
  updatedAt        DateTime       @updatedAt
  
  @@unique([cartId, productVariantId])
  @@index([cartId])
  @@index([productVariantId])
  @@map("cart_items")
}

// === ПРОМОКОДЫ ===
model PromoCode {
  id           String    @id @default(uuid())
  code         String    @unique
  discountId   String
  discount     Discount  @relation(fields: [discountId], references: [id])
  validFrom    DateTime
  validUntil   DateTime
  maxUses      Int?
  currentUses  Int       @default(0)
  isActive     Boolean   @default(true)
  createdAt    DateTime  @default(now())
  
  carts        Cart[]
  
  @@map("promo_codes")
}

model Discount {
  id             String      @id @default(uuid())
  name           String?
  type           String      // PERCENT | FIXED_AMOUNT
  value          Decimal     @db.Decimal(10, 2)
  minOrderAmount Decimal?    @db.Decimal(10, 2)
  validFrom      DateTime
  validUntil     DateTime
  isActive       Boolean     @default(true)
  createdAt      DateTime    @default(now())
  
  promoCodes     PromoCode[]
  
  @@map("discounts")
}

// === ЗАКАЗЫ ===
model Order {
  id                String                 @id @default(uuid())
  publicId          String                 @unique // ORD-YYYY-NNNNNN
  clientId          String
  client            Client                 @relation(fields: [clientId], references: [id])
  createdByAdminId  String?
  createdByAdmin    AdminUser?             @relation("OrderCreatedBy", fields: [createdByAdminId], references: [id])
  status            String                 @default("pending") // pending|confirmed|processing|shipped|delivered|cancelled
  totalAmount       Decimal                @db.Decimal(12, 2)
  currency          String                 @default("RUB")
  shippingAddress   Json?
  notes             String?
  createdAt         DateTime               @default(now())
  updatedAt         DateTime               @updatedAt
  
  items             OrderItem[]
  statusHistory     OrderStatusHistory[]
  messages          Message[]
  
  @@index([clientId])
  @@index([status])
  @@index([createdAt])
  @@map("orders")
}

// === ПОЗИЦИИ ЗАКАЗА (метражная модель!) ===
model OrderItem {
  id                 String   @id @default(uuid())
  orderId            String
  order              Order    @relation(fields: [orderId], references: [id], onDelete: Cascade)
  fabricId           Int      // ID товара (snapshot)
  color              String   // Цвет (snapshot)
  requestedMeters    Decimal  @db.Decimal(10, 2) // Заказано метров
  fulfilledMeters    Decimal? @db.Decimal(10, 2) // Отгружено метров
  unitPricePerMeter  Decimal  @db.Decimal(10, 2) // Цена за метр (snapshot)
  rolls              Int?     // CEIL(meters / rollLength)
  rollAllocations    Json?    // Конкретные рулоны
  totalPrice         Decimal  @db.Decimal(12, 2) // requestedMeters * unitPricePerMeter
  createdAt          DateTime @default(now())
  
  @@index([orderId])
  @@map("order_items")
}

// === ИСТОРИЯ СТАТУСОВ ЗАКАЗА ===
model OrderStatusHistory {
  id             String   @id @default(uuid())
  orderId        String
  order          Order    @relation(fields: [orderId], references: [id], onDelete: Cascade)
  status         String
  changedByAdmin String?
  comment        String?
  createdAt      DateTime @default(now())
  
  @@index([orderId])
  @@map("order_status_history")
}

// === СООБЩЕНИЯ (чат менеджер-клиент) ===
model Message {
  id         String      @id @default(uuid())
  orderId    String?
  order      Order?      @relation(fields: [orderId], references: [id])
  senderId   String?
  sender     Client?     @relation("SenderMessages", fields: [senderId], references: [id])
  adminId    String?
  admin      AdminUser?  @relation("AdminMessages", fields: [adminId], references: [id])
  senderType String      // CLIENT | ADMIN | SYSTEM
  content    String
  isRead     Boolean     @default(false)
  readAt     DateTime?
  createdAt  DateTime    @default(now())
  
  @@index([orderId])
  @@index([senderId])
  @@index([adminId])
  @@map("messages")
}