# АУДИТ СТАРОГО ЛИЧНОГО КАБИНЕТА
**Дата анализа:** 2025-01-XX  
**Версия:** 1.0.0  
**Статус:** Полный анализ без изменений

---

## 1. КРАТКОЕ РЕЗЮМЕ

Старый личный кабинет представляет собой **модульную архитектуру** на чистом JavaScript, расположенную в директории `/frontend/cabinet/`. Модуль состоит из 4 основных файлов (JS) и стилей (CSS). Кабинет подключён ко **всем основным страницам сайта** через скрипты в футере. Работает в режиме **mock-данных** (MOCK_ENABLED = true), реальный backend не подключён. Использует **localStorage** для токена авторизации. Интегрирован с корзиной через **CustomEvents**. Создан для интеграции с WordPress REST API, но на данный момент не подключён к реальному backend.

---

## 2. ТАБЛИЦА ФАЙЛОВ СТАРОГО ЛК

| Путь | Тип | Назначение | Размер | Статус |
|------|-----|------------|--------|--------|
| `frontend/cabinet/index.html` | HTML | Основная страница кабинета | ~443 строки | АКТИВЕН |
| `frontend/cabinet/index_old.html` | HTML | Старая версия (резервная копия) | ~443 строки | НЕ ИСПОЛЬЗУЕТСЯ |
| `frontend/cabinet/cabinet.js` | JavaScript | UI компоненты, рендеринг, события | ~749 строк | АКТИВЕН |
| `frontend/cabinet/cabinet-store.js` | JavaScript | Централизованное состояние (реактивный store) | ~584 строки | АКТИВЕН |
| `frontend/cabinet/cabinet-api.js` | JavaScript | API-адаптер (mock/WordPress-ready) | ~573 строки | АКТИВЕН |
| `frontend/cabinet/cabinet.css` | CSS | Стили кабинета | ~1519 строк | АКТИВЕН |
| `frontend/cabinet/README.md` | Документация | Техническая документация модуля | ~256 строк | СПРАВОЧНЫЙ |

**ИТОГО:** 7 файлов, из них 5 активных компонентов.

---

## 3. КАК ПОДКЛЮЧЁН К САЙТУ

### 3.1. Подключение CSS
**Механизм:** Прямое подключение через `<link>` в `<head>`  
**Файлы, где подключён:**
- `frontend/index.html` (строка 8)
- `frontend/catalog.html` (строка 7)
- `frontend/cart.html` (строка 9)
- `frontend/delivery.html` (строка 8)
- `frontend/videos.html` (строка 8)
- `frontend/faq.html` (строка 8)
- `frontend/discounts.html` (строка 8)
- `frontend/product.html` (строка 8)

**Код:**
```html
<link rel="stylesheet" href="cabinet/cabinet.css">
```

### 3.2. Подключение JavaScript
**Механизм:** Прямое подключение через `<script>` в конце `<body>`  
**Порядок загрузки (критичен!):**
1. `cabinet-api.js`
2. `cabinet-store.js`
3. `cabinet.js`

**Файлы, где подключён (все те же 8 страниц):**
- `frontend/index.html` (строки 2697-2699)
- `frontend/catalog.html` (строки 1963-1965)
- `frontend/cart.html` (строки 835-837)
- `frontend/delivery.html` (строки 902-904)
- `frontend/videos.html` (строки 485-487)
- `frontend/faq.html` (строки 694-696)
- `frontend/discounts.html` (строки 798-800)
- `frontend/product.html` (строки 30-32)

**Код:**
```html
<script src="cabinet/cabinet-api.js"></script>
<script src="cabinet/cabinet-store.js"></script>
<script src="cabinet/cabinet.js"></script>
```

### 3.3. Автоматическая инициализация
**Механизм:** Слушатель `DOMContentLoaded` в `cabinet.js` (строки 730-748)

**Что делает:**
1. Проверяет наличие `#cabinet-app` → инициализирует страницу кабинета
2. Проверяет наличие `#cabinet-header-btn` → рендерит кнопку "Личный кабинет" в header

**Критичность:** ВЫСОКАЯ — кнопка в header инициализируется автоматически на всех страницах.

---

## 4. ЧТО ДЕЛАЕТ ФУНКЦИОНАЛЬНО

### 4.1. Модуль: Авторизация / Регистрация

**Файлы:**
- `cabinet-api.js` — методы API (login, register, socialAuth)
- `cabinet-store.js` — состояние авторизации
- `cabinet.js` — UI форм входа/регистрации

**Функции:**
- Вход по email + пароль
- Регистрация нового пользователя
- Восстановление пароля
- Социальная авторизация (Google, VK) — UI готов, логика mock

**Backend:** Frontend готов, backend не подключён (MOCK_ENABLED = true)

**Использование:** АКТИВНО (работает с mock-данными)

---

### 4.2. Модуль: Профиль пользователя

**Файлы:**
- `cabinet-api.js` — методы getProfile, updateProfile
- `cabinet-store.js` — состояние профиля
- `cabinet.js` — UI формы профиля

**Функции:**
- Отображение данных пользователя (имя, email, телефон)
- Редактирование профиля
- Проверка верификации email

**Backend:** Frontend готов, backend не подключён

**Использование:** АКТИВНО (работает с mock-данными)

---

### 4.3. Модуль: Заказы (заявки)

**Файлы:**
- `cabinet-api.js` — методы getOrders, getOrderById, submitOrder
- `cabinet-store.js` — состояние заказов
- `cabinet.js` — UI списка заказов и деталей заказа

**Функции:**
- Список всех заказов пользователя
- Детали конкретного заказа
- Создание нового заказа из корзины (через событие `cart:submit-order`)

**Backend:** Frontend готов, backend не подключён

**Использование:** АКТИВНО (работает с mock-данными)

**Интеграция с корзиной:** ДА — через CustomEvent `cart:submit-order`

---

### 4.4. Модуль: Реквизиты

**Файлы:**
- `cabinet-api.js` — методы getRequisites, saveRequisites
- `cabinet-store.js` — состояние реквизитов
- `cabinet.js` — UI формы реквизитов

**Функции:**
- Отображение реквизитов (банковские, юридические данные)
- Сохранение/редактирование реквизитов
- Отображение контактных данных из профиля (read-only)

**Backend:** Frontend готов, backend не подключён

**Использование:** АКТИВНО (работает с mock-данными)

---

### 4.5. Модуль: Кнопка "Личный кабинет" в header

**Файлы:**
- `cabinet.js` — функция `renderHeaderButton()`
- Все страницы сайта — контейнер `#cabinet-header-btn`

**Функции:**
- Динамический рендеринг кнопки в header
- Отображение состояния авторизации (авторизован / не авторизован)
- Ссылка на `/cabinet` (реальная ссылка на `cabinet/index.html`)

**Расположение контейнера:**
- `frontend/index.html` (строка 817)

**Использование:** КРИТИЧЕСКИ ВАЖНО — используется на всех страницах

**CSS стили для кнопки:**
- Инлайн-стили в `frontend/index.html` (строки 335-457)

---

## 5. BACKEND-ЗАВИСИМОСТИ

### 5.1. API Endpoints (WordPress REST API готовность)

**База:** `/wp-json/cabinet/v1`

**Endpoints:**

| Метод | Endpoint | Назначение | Используется новым ЛК | Статус |
|-------|----------|------------|----------------------|--------|
| POST | `/auth/login` | Вход | НЕИЗВЕСТНО | Не реализован |
| POST | `/auth/logout` | Выход | НЕИЗВЕСТНО | Не реализован |
| POST | `/auth/register` | Регистрация | НЕИЗВЕСТНО | Не реализован |
| POST | `/auth/verify-email` | Верификация email | НЕИЗВЕСТНО | Не реализован |
| POST | `/auth/reset-password` | Сброс пароля | НЕИЗВЕСТНО | Не реализован |
| POST | `/auth/social` | Социальная авторизация | НЕИЗВЕСТНО | Не реализован |
| GET | `/user/profile` | Получить профиль | НЕИЗВЕСТНО | Не реализован |
| PUT | `/user/profile` | Обновить профиль | НЕИЗВЕСТНО | Не реализован |
| GET | `/orders` | Список заказов | НЕИЗВЕСТНО | Не реализован |
| GET | `/orders/{id}` | Детали заказа | НЕИЗВЕСТНО | Не реализован |
| POST | `/orders` | Создать заказ | НЕИЗВЕСТНО | Не реализован |
| GET | `/user/requisites` | Получить реквизиты | НЕИЗВЕСТНО | Не реализован |
| PUT | `/user/requisites` | Сохранить реквизиты | НЕИЗВЕСТНО | Не реализован |
| GET | `/admin/users/search` | Поиск пользователей (админ) | НЕИЗВЕСТНО | Не реализован |
| GET | `/admin/users/{id}` | Данные пользователя (админ) | НЕИЗВЕСТНО | Не реализован |

**ВСЕ ENDPOINTS НЕ РЕАЛИЗОВАНЫ** — работает только mock-режим.

---

### 5.2. База данных

**Использование:** НЕ ОПРЕДЕЛЕНО

**Примечание:** В коде нет прямых обращений к БД. Все данные хранятся в mock-объектах в памяти (`cabinet-api.js`, строки 107-163). При подключении реального backend ожидается использование WordPress user_meta и custom post types для заказов.

**Таблицы/Структуры, которые могут использоваться (предположительно):**
- `wp_users` — пользователи
- `wp_usermeta` — метаданные пользователей (профиль, реквизиты)
- Custom post type `cabinet_order` — заказы (предположительно)
- Custom taxonomy для статусов заказов (предположительно)

**Статус:** НЕИЗВЕСТНО — реальный backend не подключён.

---

### 5.3. Хранение токенов авторизации

**Механизм:** `localStorage`

**Ключ:** `cabinet_token`

**Использование:**
- Сохранение: `localStorage.setItem('cabinet_token', token)` (cabinet-api.js:406, 433)
- Чтение: `localStorage.getItem('cabinet_token')` (cabinet-api.js:181, 452)
- Удаление: `localStorage.removeItem('cabinet_token')` (cabinet-api.js:417, 459)

**Формат токена:** Предположительно JWT (в mock-режиме: `'mock_token_' + user.id`)

**Критичность:** ВЫСОКАЯ — при удалении старого ЛК нужно убедиться, что новый ЛК использует тот же ключ или мигрирует данные.

---

### 5.4. Cookies / Sessions

**Использование:** НЕ ОБНАРУЖЕНО

**Примечание:** В коде нет прямого использования cookies или PHP sessions. Вся авторизация основана на localStorage токене.

---

## 6. ГЛОБАЛЬНЫЕ ЗАВИСИМОСТИ И РИСКИ

### 6.1. Глобальные JavaScript объекты

**Объекты:**
- `CabinetAPI` — API-адаптер (IIFE, экспортируется через module.exports)
- `CabinetStore` — состояние приложения (IIFE, экспортируется через module.exports)
- `CabinetUI` — UI компоненты (IIFE, экспортируется через module.exports)

**Доступность:** Все объекты доступны глобально через IIFE pattern, но не записываются в `window.*` явно.

**Риск при удалении:** СРЕДНИЙ — другие модули могут обращаться к этим объектам (но в коде не обнаружено).

---

### 6.2. CustomEvents (DOM события)

**Исходящие события (кабинет → другие модули):**

| Событие | Данные | Использование | Риск |
|---------|--------|---------------|------|
| `cabinet:auth-changed` | `{ isAuthenticated, user }` | Обновление кнопки в header | КРИТИЧЕСКИЙ |
| `cabinet:order-submitted` | `{ order }` | Уведомление о созданном заказе | СРЕДНИЙ |
| `cabinet:state-change` | `{ state }` | Общее изменение состояния | НИЗКИЙ |

**Входящие события (другие модули → кабинет):**

| Событие | Источник | Данные | Риск |
|---------|----------|--------|------|
| `cart:submit-order` | `frontend/cart.html` | `{ items: [...] }` | КРИТИЧЕСКИЙ |

**Обработка:**
- `cabinet.js` слушает `cart:submit-order` (строка 715)
- `cart.html` отправляет событие при оформлении заказа (строка 829)

**Критичность:** ВЫСОКАЯ — при удалении старого ЛК корзина потеряет возможность создавать заказы через это событие.

---

### 6.3. DOM-зависимости

**Контейнеры (ID, которые ожидает кабинет):**

| ID | Назначение | Расположение | Критичность |
|----|------------|--------------|-------------|
| `#cabinet-app` | Основной контейнер кабинета | `frontend/cabinet/index.html` | КРИТИЧЕСКАЯ |
| `#cabinet-sidebar` | Боковая панель | Внутри `#cabinet-app` | КРИТИЧЕСКАЯ |
| `#cabinet-content` | Контентная область | Внутри `#cabinet-app` | КРИТИЧЕСКАЯ |
| `#cabinet-header-btn` | Кнопка в header | `frontend/index.html:817` | КРИТИЧЕСКАЯ |

**Риск при удалении:** ВЫСОКИЙ — если удалить скрипты кабинета, контейнер `#cabinet-header-btn` останется пустым на всех страницах.

---

### 6.4. CSS-переменные

**Использование:** Да, кабинет использует CSS-переменные для дизайн-системы (cabinet.css, строки 4-64).

**Конфликты:** Возможны конфликты с переменными основного сайта (например, `--cabinet-primary` может пересекаться с другими переменными).

**Риск:** НИЗКИЙ — CSS переменные изолированы префиксом `--cabinet-*`.

---

## 7. ТОЧКИ ВХОДА ПОЛЬЗОВАТЕЛЯ

### 7.1. URL-адреса

**Основной URL кабинета:**
- `/cabinet` или `/cabinet/index.html` — страница личного кабинета

**Реальная ссылка в коде:**
- `cabinet.js:107` — `href="/cabinet"`

**Примечание:** В структуре проекта файл находится по пути `frontend/cabinet/index.html`, что означает, что URL должен быть либо `/cabinet/index.html`, либо сервер должен настроить rewrite на `/cabinet`.

---

### 7.2. Кнопки / Ссылки

**Кнопка "Личный кабинет" в header:**
- Расположение: `frontend/index.html:817` (контейнер `#cabinet-header-btn`)
- Рендерится автоматически через `cabinet.js`
- Видна на всех страницах сайта (если подключены скрипты кабинета)

**Статусы кнопки:**
- Не авторизован: "Личный кабинет" (иконка пользователя)
- Авторизован: "Личный кабинет" (иконка пользователя + класс `--authorized`)

---

## 8. СТАТУС ИСПОЛЬЗОВАНИЯ

### 8.1. Компоненты

| Компонент | Статус | Примечание |
|-----------|--------|------------|
| Авторизация | АКТИВНО (mock) | Работает с тестовыми данными |
| Регистрация | АКТИВНО (mock) | Работает с тестовыми данными |
| Профиль | АКТИВНО (mock) | Работает с тестовыми данными |
| Заказы | АКТИВНО (mock) | Работает с тестовыми данными |
| Реквизиты | АКТИВНО (mock) | Работает с тестовыми данными |
| Кнопка в header | АКТИВНО | Рендерится на всех страницах |
| Интеграция с корзиной | АКТИВНО | Событие `cart:submit-order` обрабатывается |

### 8.2. Файлы

| Файл | Статус | Примечание |
|------|--------|------------|
| `cabinet/index.html` | АКТИВЕН | Основная страница кабинета |
| `cabinet/index_old.html` | НЕ ИСПОЛЬЗУЕТСЯ | Резервная копия, можно удалить |
| `cabinet/cabinet.js` | АКТИВЕН | Критически важен |
| `cabinet/cabinet-store.js` | АКТИВЕН | Критически важен |
| `cabinet/cabinet-api.js` | АКТИВЕН | Критически важен (mock-режим) |
| `cabinet/cabinet.css` | АКТИВЕН | Используется на всех страницах |
| `cabinet/README.md` | СПРАВОЧНЫЙ | Документация |

---

## 9. РИСКИ ПРИ УДАЛЕНИИ

### 9.1. Критические риски (поломка сайта)

1. **Пустая кнопка в header**
   - **Где:** `#cabinet-header-btn` на всех страницах
   - **Проблема:** Если удалить скрипты кабинета, кнопка не будет рендериться
   - **Решение:** Обеспечить замену через новый ЛК ИЛИ удалить контейнер

2. **Потеря интеграции с корзиной**
   - **Где:** `cart.html` отправляет событие `cart:submit-order`
   - **Проблема:** Новый ЛК должен слушать это же событие
   - **Решение:** Новый ЛК должен реализовать обработчик `cart:submit-order`

3. **Потеря токена авторизации**
   - **Где:** `localStorage.getItem('cabinet_token')`
   - **Проблема:** Если новый ЛК использует другой ключ, пользователи будут разлогинены
   - **Решение:** Новый ЛК должен использовать тот же ключ или мигрировать данные

---

### 9.2. Средние риски (частичная поломка)

1. **CSS конфликты**
   - **Проблема:** Удаление `cabinet.css` может повлиять на стили, если они используются вне кабинета
   - **Решение:** Проверить, не используются ли классы кабинета в других частях сайта

2. **Глобальные объекты**
   - **Проблема:** Другие скрипты могут обращаться к `CabinetAPI`, `CabinetStore`, `CabinetUI`
   - **Решение:** Проверить все JS файлы на наличие обращений к этим объектам

---

### 9.3. Низкие риски (косметические)

1. **Старые файлы**
   - `cabinet/index_old.html` можно безопасно удалить
   - Не используется, не подключён

---

## 10. ЧТО КАТЕГОРИЧЕСКИ НЕЛЬЗЯ УДАЛЯТЬ БЕЗ ЗАМЕНЫ

### 10.1. Обязательные компоненты для замены

1. **Кнопка "Личный кабинет" в header**
   - **Контейнер:** `#cabinet-header-btn` в `frontend/index.html:817`
   - **Требование:** Новый ЛК должен рендерить кнопку в этот контейнер

2. **Обработчик события `cart:submit-order`**
   - **Источник:** `frontend/cart.html:829`
   - **Требование:** Новый ЛК должен слушать это событие и создавать заказ

3. **Токен авторизации в localStorage**
   - **Ключ:** `cabinet_token`
   - **Требование:** Новый ЛК должен использовать тот же ключ ИЛИ мигрировать данные при первом входе

---

### 10.2. Обязательные файлы для проверки перед удалением

1. **Все 8 страниц, где подключён кабинет:**
   - `frontend/index.html`
   - `frontend/catalog.html`
   - `frontend/cart.html`
   - `frontend/delivery.html`
   - `frontend/videos.html`
   - `frontend/faq.html`
   - `frontend/discounts.html`
   - `frontend/product.html`

   **Действие:** Удалить 3 строки скриптов и 1 строку CSS из каждого файла ТОЛЬКО после подключения нового ЛК.

---

### 10.3. Что можно удалить безопасно (после подключения нового ЛК)

1. `frontend/cabinet/index.html` — если новый ЛК использует другой путь
2. `frontend/cabinet/cabinet.js` — после замены на новый
3. `frontend/cabinet/cabinet-store.js` — после замены на новый
4. `frontend/cabinet/cabinet-api.js` — после замены на новый
5. `frontend/cabinet/cabinet.css` — после замены на новый (если новый использует другие стили)
6. `frontend/cabinet/index_old.html` — можно удалить в любой момент
7. `frontend/cabinet/README.md` — можно удалить после миграции

---

## 11. НЕОПРЕДЕЛЁННЫЕ МОМЕНТЫ (требуют проверки)

1. **Реальный backend**
   - Неизвестно, есть ли на сервере реализация WordPress endpoints
   - Требуется проверка: существует ли `/wp-json/cabinet/v1/*`

2. **База данных**
   - Неизвестно, какие таблицы/структуры используются
   - Требуется проверка: есть ли custom post types для заказов

3. **Использование другими модулями**
   - Неизвестно, обращаются ли другие скрипты к `CabinetAPI`, `CabinetStore`, `CabinetUI`
   - Требуется проверка: поиск по всем JS файлам

4. **CSS конфликты**
   - Неизвестно, используются ли классы кабинета вне кабинета
   - Требуется проверка: поиск по всем HTML/CSS файлам

5. **URL структура**
   - Неизвестно, настроен ли rewrite на `/cabinet` → `cabinet/index.html`
   - Требуется проверка: конфигурация сервера

---

## 12. РЕКОМЕНДАЦИИ ПО БЕЗОПАСНОМУ УДАЛЕНИЮ

1. **Подготовка:**
   - Убедиться, что новый ЛК полностью функционален
   - Протестировать все функции нового ЛК
   - Проверить интеграцию с корзиной

2. **Миграция данных:**
   - Если новый ЛК использует другой ключ токена, реализовать миграцию
   - Сохранить совместимость с событием `cart:submit-order`

3. **Постепенная замена:**
   - Сначала подключить новый ЛК параллельно со старым
   - Переключить кнопку в header на новый ЛК
   - Удалить старые скрипты после тестирования
   - Удалить старые файлы после полной проверки

4. **Контроль:**
   - Мониторить ошибки в консоли браузера
   - Проверить работу корзины после удаления
   - Проверить авторизацию пользователей

---

**Конец отчёта**



