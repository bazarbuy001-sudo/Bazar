# Аудит каталога товаров — текущее состояние

## Статус: ТОЛЬКО ОПИСАНИЕ ТЕКУЩЕГО КОДА

**Дата аудита:** Текущая дата  
**Задача:** Описать существующее состояние кода для интеграции ТЗ

---

## 1️⃣ DataStore / State

### Единый источник данных

**Название:** `CatalogDataStore`  
**Файл:** `frontend/js/catalog/dataStore.js`  
**Статус:** ✅ Существует

### Что хранит:

- Кэш всех товаров после загрузки (через абстракцию источника данных)
- Не хранит состояние фильтров/сортировки/пагинации (это отдельные модули)

### Интерфейс:

- `load(source)` — загрузка данных (async)
- `getAllProducts()` — получить все товары (массив)
- `getProductById(productId)` — получить товар по ID
- `setDataSource(dataSource)` — заменить источник данных
- `detectParamType(paramKey)` — определить тип параметра (list/range/boolean)
- `getUniqueValues(paramKey)` — получить уникальные значения параметра
- `getFilterableKeys()` — получить список фильтруемых ключей

### Источники данных (абстракция):

1. **LocalJSONSource** (`frontend/js/catalog/data-sources/localJSONSource.js`)
   - Загружает из JSON файла
   - Кэширует данные в памяти
   - Используется по умолчанию

2. **WordPressRESTSource** (`frontend/js/catalog/data-sources/wordpressRESTSource.js`)
   - Заглушка для будущей интеграции WordPress
   - Методы не реализованы (TODO)
   - Возвращает пустые массивы

### Другие Store в проекте:

- `CartStore` (`frontend/js/cart-store.js`) — хранилище корзины (отдельно от каталога)
- `CabinetStore` (`frontend/cabinet/cabinet-store.js`) — хранилище кабинета (отдельно)

### Дубли данных:

- ❌ Нет дублей между CatalogDataStore и другими store
- ✅ CatalogDataStore используется и каталогом, и popup карточкой товара

---

## 2️⃣ Event / Communication Model

### EventBus

**Название:** `CatalogEventBus`  
**Файл:** `frontend/js/catalog/eventBus.js`  
**Статус:** ✅ Существует

### Интерфейс:

- `on(eventName, handler)` — подписка на событие (возвращает функцию отписки)
- `emit(eventName, payload)` — отправка события

### Реализация:

- Использует `CustomEvent` и `document.addEventListener`
- События всплывают (`bubbles: true`)
- Данные передаются через `event.detail`

### Документация событий:

**Файл:** `frontend/js/catalog/integration.js`

**Список событий:**
- `catalog:init` — инициализация каталога
- `catalog:loaded` — данные загружены
- `catalog:filtered` — фильтры/сортировка изменены
- `catalog:render` — рендер продуктов
- `catalog:openProduct` — открытие popup товара
- `product:addToCart` — добавление в корзину
- `cart:updated` — корзина обновлена

### Кто эмитит события:

**Каталог:**
- `catalog:openProduct` — эмитируется при клике на карточку товара (CatalogProductCard)

**Popup:**
- `product:addToCart` — эмитируется при добавлении товара в корзину (ProductPopup)

**Корзина:**
- `cart:updated` — эмитируется при изменении корзины (CartStore)

### Кто слушает события:

**Popup:**
- Слушает `catalog:openProduct` для открытия popup
- Слушает `cart:updated` для обновления UI состояния корзины

**Каталог:**
- Не слушает события (не найдено в коде)

**Корзина:**
- Слушает `product:addToCart` для добавления товаров (предположительно, требует проверки)

---

## 3️⃣ Каталог товаров (текущая реализация)

### Инициализация каталога

**Где инициализируется:**

1. **Главная страница** (`frontend/index.html`, строки 1873-1875):
   ```javascript
   await Catalog.load('data/products.json');
   Catalog.renderPromo();
   ```

2. **Страница каталога** (`frontend/catalog.html`, строки 1176, 1483):
   ```javascript
   await CatalogDataStore.load('data/products.json');
   ```

### Файлы каталога:

**Модульная структура** (`frontend/js/catalog/`):

1. **catalog-core.js** — ядро каталога
   - Управляет потоком: загрузка → фильтры → сортировка → пагинация
   - Состояние: `allProducts`, `filteredProducts`, `sortedProducts`, `pagedProducts`
   - Методы: `init()`, `refresh()`, `getProducts()`, `getTotalCount()`

2. **filters.js** — модуль фильтров
   - Состояние: `available` (доступные фильтры), `active` (активные фильтры)
   - Поддерживает типы: list, range, boolean
   - Специальная обработка: `fabric_type`, `colors`, `price`, `fabric_meterage`

3. **sorting.js** — модуль сортировки
   - Сортировки: по умолчанию, по цене (↑↓), по новизне
   - Работает поверх фильтров

4. **pagination.js** — модуль пагинации
   - Размер страницы: 24 товара
   - Метод `applyPagination()` возвращает товары для текущей страницы

5. **productCard.js** — рендер карточек товаров
   - Создает HTML карточки товара (preview)
   - Обработка клика: эмитит `catalog:openProduct`
   - Автоматический выбор параметров для отображения (до 3 параметров)

6. **catalog.js** (старый модуль, `frontend/js/catalog.js`)
   - Legacy модуль, использует CatalogCore внутри
   - Методы: `load()`, `filterProducts()`, `sortProducts()`, `renderPromo()`

### Загрузка товаров:

**Текущий источник:** `frontend/data/products.json`  
**Метод загрузки:** `CatalogDataStore.load('data/products.json')`  
**Формат:** JSON файл с массивом товаров

### Фильтрация:

**Где реализована:** `frontend/js/catalog/filters.js`  
**Статус:** ✅ Существует

**Типы фильтров:**
- `list` — список значений (до 20 уникальных)
- `range` — числовой диапазон (min/max)
- `boolean` — булево значение

**Специальные фильтры:**
- `fabric_type` — тип ткани (преобразование в slug)
- `colors` — цвета (массив, преобразование в slug)
- `price` — цена (диапазон, исключает `price_on_request = true`)
- `fabric_meterage` — метраж ткани (диапазон)

**Автоматическое определение фильтров:**
- `CatalogDataStore.detectParamType()` анализирует данные и определяет тип
- `CatalogDataStore.getFilterableKeys()` возвращает список ключей для фильтрации

### Поиск:

**Статус:** ⚠️ Частично отсутствует

**Что есть:**
- HTML элемент поиска: `<input class="search-input" placeholder="Поиск товаров...">` (index.html, строка 931)
- CSS стили для `.search-box`, `.search-input` (index.html, строки 331-369)

**Что отсутствует:**
- ❌ JavaScript логика поиска не найдена
- ❌ Нет обработчиков событий на `search-input`
- ❌ Нет связи с CatalogDataStore или CatalogFilters
- ❌ Поиск не интегрирован с каталогом

### Пагинация:

**Где реализована:** `frontend/js/catalog/pagination.js`  
**Статус:** ✅ Существует

**Параметры:**
- Размер страницы: 24 товара (по умолчанию)
- Метод `applyPagination()` возвращает товары для текущей страницы
- Методы: `nextPage()`, `reset()`, `getCurrentPage()`, `getPageSize()`

**Проблема:**
- Метод `applyPagination()` использует `slice(0, currentPage * pageSize)`, что означает "показать все товары до текущей страницы", а не "показать товары только текущей страницы"

---

## 4️⃣ Кнопка «Каталог товаров»

### Где находится:

**HTML:** `frontend/index.html`, строки 925-928  
**Элемент:** `<button class="catalog-btn">`

### Текущая реализация:

**Статус:** ❌ Не функциональна

**Что есть:**
- HTML кнопка с классом `.catalog-btn`
- CSS стили (index.html, строки 306-328)
- Иконка "☰" и текст "Каталог товаров"

**Что отсутствует:**
- ❌ Нет обработчика события `click`
- ❌ Нет `onclick` атрибута
- ❌ Нет JavaScript логики открытия каталога
- ❌ Нет dropdown / mega menu
- ❌ Не является ссылкой (`<a>`)

### CSS стили:

- Фон: `var(--accent-color)` (#d4a574)
- Hover: `var(--primary-color)` (#1a1a1a)
- Padding: 9px 18px
- Border-radius: 8px
- Font: DM Sans, 13px

---

## 5️⃣ Popup карточка товара

### Где реализован:

**Файл:** `frontend/js/product-popup.js`  
**CSS:** `frontend/css/product-popup.css`  
**Статус:** ✅ Существует

### Как открывается:

1. **Через событие:** слушает `catalog:openProduct` (строка 1665)
2. **Прямой вызов:** `ProductPopup.open(productId)` (публичный метод)

### Какие данные принимает:

- `productId` (string/number) — ID товара
- Загружает данные через `CatalogDataStore.getProductById(productId)`

### Есть ли URL:

**Статус:** ❌ Нет URL

- Popup открывается через JavaScript событие
- Нет маршрутизации по URL
- Нет изменения URL при открытии popup
- Нет возможности открыть popup по прямой ссылке

### Связь с каталогом:

**Статус:** ✅ Интегрирован через события

- Каталог эмитит `catalog:openProduct` при клике на карточку
- Popup слушает это событие и открывается
- Popup использует `CatalogDataStore` для загрузки данных
- Popup эмитит `product:addToCart` при добавлении в корзину

### Функциональность popup:

- Отображение товара (изображения, название, цена, характеристики)
- Выбор цвета (если есть)
- Выбор количества (метры и рулоны)
- Выбор валюты (RUB, USD, KZT, KGS)
- Добавление в корзину
- Отображение состояния корзины (если товар уже в корзине)

---

## 6️⃣ Фильтры и хештеги

### Какие фильтры существуют:

**Динамические фильтры** (генерируются автоматически из данных):

- Фильтры определяются автоматически через `CatalogDataStore.getFilterableKeys()`
- Тип фильтра определяется через `CatalogDataStore.detectParamType()`
- Нет хардкода списка фильтров

### Где захардкожены:

**Статус:** ⚠️ Частично

**Специальная обработка (хардкод логики):**
- `fabric_type` — преобразование в slug, fallback на `category`
- `colors` — массив цветов, преобразование в slug
- `price` — исключение товаров с `price_on_request = true`
- `fabric_meterage` — диапазон метража

**Поля фильтров:**
- Не захардкожены — определяются автоматически из структуры данных товаров

### Какие поля используются:

**Определяются автоматически** из структуры товаров:
- Любые поля, которые имеют тип list (≤20 уникальных значений), range (числа), boolean
- Исключаются: объекты (кроме массивов), null, undefined

**Специальные поля (с особой обработкой):**
- `fabric_type` / `category` — тип ткани
- `colors` — цвета
- `price` — цена
- `fabric_meterage` — метраж

### Динамическая генерация:

**Статус:** ✅ Существует

- `CatalogFilters.buildFilters(products)` — строит доступные фильтры из массива товаров
- `CatalogFilters.getFabricTypesWithCount()` — типы ткани с подсчетом товаров
- `CatalogFilters.getColorsWithCount()` — цвета с подсчетом товаров
- `CatalogFilters.getPriceRange()` — диапазон цен
- `CatalogFilters.getMeterageRange()` — диапазон метража

---

## 7️⃣ Поиск

### Где реализован:

**HTML элемент:** `frontend/index.html`, строка 931  
**Элемент:** `<input class="search-input" placeholder="Поиск товаров...">`

### Статус реализации:

**Статус:** ❌ Отсутствует

**Что есть:**
- HTML элемент поиска
- CSS стили (index.html, строки 331-369)

**Что отсутствует:**
- ❌ Нет JavaScript обработчиков событий (input, keydown, submit)
- ❌ Нет функции поиска в CatalogDataStore
- ❌ Нет функции поиска в CatalogFilters
- ❌ Нет функции поиска в CatalogCore
- ❌ Нет связи с каталогом
- ❌ Поиск не влияет на отображение товаров

### По каким данным должен искать:

**Не определено** (логика отсутствует)

Предположительно должен искать по:
- Названию товара (`name`)
- Описанию (`description`)
- Артикулу (`article` / `sku`)
- Возможно, по категории (`category` / `fabric_type`)

---

## 8️⃣ SEO-логика

### Canonical URL:

**Статус:** ❌ Отсутствует

- Не найдено `<link rel="canonical">` в HTML файлах
- Не найдено генерации canonical через JavaScript

### Noindex:

**Статус:** ❌ Отсутствует

- Не найдено `<meta name="robots" content="noindex">`
- Не найдено динамической генерации noindex

### URL каталога:

**Статус:** ⚠️ Частично

**Что есть:**
- Страница каталога: `catalog.html`
- Статический HTML файл

**Что отсутствует:**
- ❌ Нет параметров URL для фильтров
- ❌ Нет параметров URL для сортировки
- ❌ Нет параметров URL для пагинации
- ❌ Нет параметров URL для поиска
- ❌ Нет параметров URL для popup товара

**Что найдено:**
- В `catalog.html` (строка 1179) есть упоминание "ВОССТАНОВЛЕНИЕ ФИЛЬТРОВ ИЗ URL", но логика не реализована (комментарий)

---

## 9️⃣ ТОЧКИ ИНТЕГРАЦИИ С ТЗ

### Какие части можно использовать напрямую:

1. **CatalogDataStore** ✅
   - Единый источник данных
   - Абстракция источников данных (можно подключить WordPress)
   - Методы: `load()`, `getAllProducts()`, `getProductById()`

2. **CatalogEventBus** ✅
   - Система событий
   - Интерфейс: `on()`, `emit()`
   - Документация событий в `integration.js`

3. **CatalogFilters** ✅
   - Модуль фильтрации
   - Автоматическое определение типов фильтров
   - Методы: `init()`, `buildFilters()`, `applyFilters()`, `setFilter()`, `getActiveFilters()`
   - Методы с подсчетом: `getFabricTypesWithCount()`, `getColorsWithCount()`, `getPriceRange()`, `getMeterageRange()`

4. **CatalogSorting** ✅
   - Модуль сортировки
   - Методы: `init()`, `applySorting()`, `setSort()`, `reset()`

5. **CatalogPagination** ✅
   - Модуль пагинации
   - Методы: `init()`, `applyPagination()`, `nextPage()`, `reset()`

6. **CatalogProductCard** ✅
   - Рендер карточек товаров
   - Метод: `render(product)`

7. **ProductPopup** ✅
   - Popup карточки товара
   - Методы: `open(productId)`, `close()`, `isOpen()`
   - Интегрирован с CatalogDataStore и событиями

8. **CatalogCore** ✅
   - Ядро каталога
   - Управляет потоком: загрузка → фильтры → сортировка → пагинация
   - Методы: `init()`, `refresh()`, `getProducts()`, `getTotalCount()`

### Какие части нужно ДОПОЛНИТЬ:

1. **Кнопка "Каталог товаров"** ⚠️
   - Нужно добавить обработчик клика
   - Нужно решить: ссылка на `catalog.html` или dropdown/mega menu

2. **Поиск** ❌
   - Полностью отсутствует логика
   - Нужно добавить: обработчики событий, функцию поиска, интеграцию с CatalogCore

3. **URL параметры** ❌
   - Нет синхронизации фильтров/сортировки/поиска с URL
   - Нет восстановления состояния из URL

4. **SEO мета-теги** ❌
   - Нет canonical URL
   - Нет noindex для определенных страниц
   - Нет генерации мета-тегов для страниц каталога

5. **Пагинация (исправление)** ⚠️
   - Метод `applyPagination()` работает неправильно (показывает все товары до текущей страницы, а не только текущую страницу)

6. **WordPress интеграция** ⚠️
   - `WordPressRESTSource` — заглушка
   - Нужна реализация методов загрузки данных из WordPress REST API

### Какие части отсутствуют полностью:

1. **Маршрутизация URL** ❌
   - Нет роутинга для popup товара
   - Нет параметров URL для фильтров/сортировки/поиска

2. **Генерация SEO мета-тегов** ❌
   - Нет динамической генерации title, description, keywords
   - Нет canonical URL

3. **Поиск** ❌
   - Полностью отсутствует функциональность

4. **Хештеги в URL** ❌
   - Нет поддержки хештегов в URL для фильтров/категорий

---

## Резюме

### Что работает:

- ✅ Единый источник данных (CatalogDataStore)
- ✅ Система событий (CatalogEventBus)
- ✅ Фильтрация (динамическая генерация фильтров)
- ✅ Сортировка
- ✅ Пагинация (с ошибкой в логике)
- ✅ Popup карточки товара
- ✅ Рендер карточек товаров

### Что нужно дополнить:

- ⚠️ Кнопка "Каталог товаров" (добавить функциональность)
- ⚠️ Исправить логику пагинации
- ⚠️ Реализовать WordPressRESTSource

### Что отсутствует:

- ❌ Поиск (полностью)
- ❌ URL параметры и маршрутизация
- ❌ SEO мета-теги (canonical, noindex)
- ❌ Генерация мета-тегов для страниц

