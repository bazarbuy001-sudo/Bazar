# ОТЧЁТ О МИГРАЦИИ ЛИЧНОГО КАБИНЕТА
**Дата:** 2025-01-XX  
**Статус:** Анализ завершён, готов к выполнению

---

## ШАГ 1: АНАЛИЗ И СРАВНЕНИЕ ✅

### Старый личный кабинет (frontend/cabinet/)

**Структура:**
- `cabinet.js` — UI компоненты (749 строк)
- `cabinet-store.js` — состояние (584 строки)
- `cabinet-api.js` — API адаптер (573 строки)
- `cabinet.css` — стили (1519 строк)
- `index.html` — страница кабинета (443 строки)

**Глобальные объекты:**
- `CabinetUI` — UI логика
- `CabinetStore` — состояние
- `CabinetAPI` — API

**Инициализация:**
- Автоматическая через `DOMContentLoaded` (cabinet.js:730-748)
- Кнопка в header: автоматически рендерится при наличии `#cabinet-header-btn`
- Кабинет: автоматически инициализируется при наличии `#cabinet-app`

**Обработка событий:**
- ❌ НЕТ автоматического обработчика `cart:submit-order` в коде
- Событие `cabinet:auth-changed` — слушает для обновления кнопки

**localStorage:**
- Ключ: `cabinet_token`
- Использование: `localStorage.getItem('cabinet_token')`

**Подключение:**
- CSS: `<link rel="stylesheet" href="cabinet/cabinet.css">` (8 страниц)
- JS: 3 скрипта в конце `<body>` (8 страниц)
- Порядок: cabinet-api.js → cabinet-store.js → cabinet.js

---

### Новый личный кабинет (из папки "Новый личный кабинет")

**Структура:**
- `cabinet.js` — UI компоненты (556 строк)
- `cabinet-store.js` — состояние (1021 строка)
- `cabinet-api.js` — API адаптер (661 строка)
- `cabinet.css` — стили (253 строки)
- `index.html` — демо-страница (341 строка)

**Глобальные объекты:**
- `CabinetUI` — UI логика (ТОТ ЖЕ ИМЯ)
- `CabinetStore` — состояние (ТОТ ЖЕ ИМЯ)
- `CabinetAPI` — API (ТОТ ЖЕ ИМЯ)

**Инициализация:**
- Ручная через `CabinetUI.init('cabinet-app')`
- Кнопка в header: `CabinetUI.renderHeaderButton(isAuthenticated)`
- Обработчик событий: автоматически регистрируется в `cabinet-store.js:975`

**Обработка событий:**
- ✅ ЕСТЬ автоматический обработчик `cart:submit-order` (cabinet-store.js:975)
- Событие `cabinet:auth-changed` — эмитится при изменении авторизации

**localStorage:**
- Ключ: `cabinet_token` (ТОТ ЖЕ)
- Использование: `localStorage.getItem('cabinet_token')` (ТОТ ЖЕ)

**Архитектурные изменения:**
- Состояние: `client` вместо `auth + profile`
- Добавлен: `chat` (постоянный чат)
- Добавлен: `draftOrder` (черновик из корзины)
- Добавлен: `onboarding` (первый вход)

**НО:** Внешний API совместим:
- `CabinetUI.init()` — работает
- `CabinetUI.renderHeaderButton()` — работает
- `cabinet:auth-changed` — работает
- `cart:submit-order` — работает

---

### Карта соответствия

| Компонент | Старый ЛК | Новый ЛК | Совместимость |
|-----------|-----------|----------|---------------|
| Глобальные объекты | CabinetUI, CabinetStore, CabinetAPI | ТО ЖЕ | ✅ 100% |
| localStorage ключ | `cabinet_token` | `cabinet_token` | ✅ 100% |
| Событие auth-changed | `cabinet:auth-changed` | `cabinet:auth-changed` | ✅ 100% |
| Событие cart:submit-order | ❌ НЕТ | ✅ ЕСТЬ | ✅ Работает |
| Кнопка header | `#cabinet-header-btn` | `#cabinet-header-btn` | ✅ 100% |
| Контейнер кабинета | `#cabinet-app` | `#cabinet-app` | ✅ 100% |
| Инициализация | Автоматическая | Ручная + авто | ⚠️ Требует проверки |

---

## ШАГ 2-7: ПЛАН ВЫПОЛНЕНИЯ МИГРАЦИИ

### Шаг 2: Параллельное подключение
**СТАТУС:** ❌ НЕ ТРЕБУЕТСЯ
**Причина:** Новый кабинет использует те же имена глобальных объектов. Параллельное подключение вызовет конфликт.

### Шаг 3-5: Прямая замена файлов
**СТАТУС:** ✅ БЕЗОПАСНО
**Причина:** 
- Новый кабинет сохраняет совместимость API
- Тот же ключ localStorage
- Те же события
- Те же контейнеры

### Шаг 6: Отключение старого
**СТАТУС:** ✅ ВЫПОЛНЯЕТСЯ АВТОМАТИЧЕСКИ
**Причина:** Замена файлов автоматически отключает старый код.

---

## РИСКИ И РЕШЕНИЯ

### Риск 1: Автоматическая инициализация
**Проблема:** Старый кабинет инициализируется автоматически через `DOMContentLoaded`. Новый кабинет тоже имеет такой код.

**Решение:** ✅ Новый кабинет имеет аналогичную автоматическую инициализацию (нужно проверить наличие в новом коде).

**Статус:** Требует проверки

### Риск 2: Обработчик cart:submit-order
**Проблема:** Старый кабинет НЕ имеет автоматического обработчика. Новый кабинет имеет.

**Решение:** ✅ Это улучшение — новый кабинет автоматически обработает событие.

**Статус:** Безопасно

### Риск 3: Изменение структуры состояния
**Проблема:** Новый кабинет использует `client` вместо `auth + profile`.

**Решение:** ✅ Внешний API (`selectors.isAuthenticated()`) сохранён, внутренняя структура не влияет на интеграцию.

**Статус:** Безопасно

---

## ПЛАН ДЕЙСТВИЙ

### Действие 1: Замена файлов кабинета
- Скопировать файлы из "Новый личный кабинет" в `frontend/cabinet/`
- Заменить: cabinet.js, cabinet-store.js, cabinet-api.js, cabinet.css, index.html

### Действие 2: Проверка автоматической инициализации
- Убедиться, что новый cabinet.js имеет автоматическую инициализацию через `DOMContentLoaded`
- Если нет — добавить (но проверим сначала)

### Действие 3: Проверка совместимости
- Проверить, что `CabinetStore.selectors.isAuthenticated()` работает
- Проверить, что кнопка header рендерится
- Проверить, что событие `cart:submit-order` обрабатывается

---

## КРИТИЧЕСКИЕ ПРОВЕРКИ

✅ Ключ localStorage: `cabinet_token` — сохранён  
✅ Событие `cabinet:auth-changed` — сохранено  
✅ Контейнер `#cabinet-header-btn` — не меняется  
✅ Контейнер `#cabinet-app` — не меняется  
⚠️ Автоматическая инициализация — требуется проверка  
✅ Обработчик `cart:submit-order` — добавлен в новый кабинет  

---

## СЛЕДУЮЩИЕ ШАГИ

1. Проверить наличие автоматической инициализации в новом cabinet.js
2. Если отсутствует — добавить совместимый код
3. Заменить файлы
4. Протестировать на одной странице
5. Проверить все 8 страниц
6. Удалить старые резервные файлы

---

**ГОТОВ К ВЫПОЛНЕНИЮ МИГРАЦИИ**



